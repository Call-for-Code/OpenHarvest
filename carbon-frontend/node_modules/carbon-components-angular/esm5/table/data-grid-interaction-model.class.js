/**
 *
 * carbon-angular v0.0.0 | data-grid-interaction-model.class.js
 *
 * Copyright 2014, 2021 IBM
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0

 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


import * as tslib_1 from "tslib";
import { BehaviorSubject, combineLatest } from "rxjs";
import { map } from "rxjs/operators";
import { tabbableSelectorIgnoreTabIndex, getFocusElementList } from "carbon-components-angular/common";
/**
 * `DataGridInteractionModel` provides centralized control over arbitrary 2d grids, following the w3 specs.
 *
 * Refs:
 *  - https://www.w3.org/TR/wai-aria-practices/examples/grid/dataGrids.html
 *  - https://www.w3.org/TR/wai-aria-practices/#grid
 *
 * Example usage (taken from `table.component`):
```typescript
// a standard HTML table
const table = this.elementRef.nativeElement.querySelector("table") as HTMLTableElement;

// `TableDomAdapter` implements `TableAdapter` and provides a consistent interface to query rows and columns in a table
const tableAdapter = new TableDomAdapter(table);

// the keydown events that we'll use for keyboard navigation of the table
const keydownEventStream = fromEvent<KeyboardEvent>(table, "keydown");

// the click events we'll use to ensure focus is updated correctly on click
const clickEventStream = fromEvent<MouseEvent>(table, "click");

// the `DataGridInteractionModel` instance!
this.interactionModel = new DataGridInteractionModel(keydownEventStream, clickEventStream, tableAdapter);

// subscribe to the combined position updates
this.interactionModel.position.subscribe(event => {
    const [currentRow, currentColumn] = event.current;
    const [previousRow, previousColumn] = event.previous;

    // query the TableAdapter for the cell at the current row and column ...
    const currentElement = tableAdapter.getCell(currentRow, currentColumn);
    // ... and make it focusable it
    Table.setTabIndex(currentElement, 0);

    // if the model has just initialized don't focus or reset anything
    if (previousRow === -1 || previousColumn === -1) { return; }

    // query the TableAdapter for the cell at the previous row and column ...
    const previousElement = tableAdapter.getCell(previousRow, previousColumn);
    // ... and make it unfocusable (now there is only a single focusable cell)
    Table.setTabIndex(previousElement, -1);

    // finally, focus the current cell (skipped during initilzation)
    Table.focus(currentElement);
});
```
 */
var DataGridInteractionModel = /** @class */ (function () {
    /**
     * `DataGridInteractionModel` requires knowledge of events, and a representation of your table/grid to be useful.
     *
     * @param keyboardEventStream an Observable of KeyboardEvents. Should be scoped to the table container.
     * @param clickEventStream an Observable of ClickEvents. should only include clicks that take action on items known by the TableAdapter
     * @param tableAdapter an instance of a concrete class that implements TableAdapter. The standard carbon table uses TableDomAdapter
     */
    function DataGridInteractionModel(keyboardEventStream, clickEventStream, tableAdapter) {
        this.keyboardEventStream = keyboardEventStream;
        this.clickEventStream = clickEventStream;
        this.tableAdapter = tableAdapter;
        /**
         * Internal subject to handle changes in row
         */
        this.rowSubject = new BehaviorSubject({ current: 0, previous: -1 });
        /**
         * Internal subject to handle changes in column
         */
        this.columnSubject = new BehaviorSubject({ current: 0, previous: -1 });
        this.rowIndex = this.rowSubject.asObservable();
        this.columnIndex = this.columnSubject.asObservable();
        this.position = combineLatest(this.rowIndex, this.columnIndex).pipe(map(function (positions) {
            var _a = tslib_1.__read(positions, 2), row = _a[0], column = _a[1];
            return {
                current: [row.current, column.current],
                previous: [row.previous, column.previous]
            };
        }));
        this.keyboardEventStream.subscribe(this.handleKeyboardEvent.bind(this));
        this.clickEventStream.subscribe(this.handleClickEvent.bind(this));
    }
    Object.defineProperty(DataGridInteractionModel.prototype, "currentRow", {
        /**
         * The latest value emitted by the rowSubject
         */
        get: function () {
            return this.rowSubject.getValue().current;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DataGridInteractionModel.prototype, "currentColumn", {
        /**
         * The latest value emitted by the columnSubject
         */
        get: function () {
            return this.columnSubject.getValue().current;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DataGridInteractionModel.prototype, "lastColumn", {
        /**
         * The last column as reported by the adapter
         */
        get: function () {
            return this.tableAdapter.lastColumnIndex;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DataGridInteractionModel.prototype, "lastRow", {
        /**
         * The last row as reported by the adapter
         */
        get: function () {
            return this.tableAdapter.lastRowIndex;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Handles moving the position according to the w3 datagrid navigation specs
     *
     * Refs:
     *  - https://www.w3.org/TR/wai-aria-practices/examples/grid/dataGrids.html
     *  - https://www.w3.org/TR/wai-aria-practices/#grid
     *
     * @param event the KeyboardEvent to handle
     */
    DataGridInteractionModel.prototype.handleKeyboardEvent = function (event) {
        var currentCell = this.tableAdapter.getCell(this.currentRow, this.currentColumn);
        var currentColumn = this.tableAdapter.findColumnIndex(currentCell);
        var currentRow = this.tableAdapter.findRowIndex(currentCell);
        switch (event.key) {
            case "Right": // IE specific value
            case "ArrowRight":
                event.preventDefault();
                // add the colspan since findColumnIndex will return the
                // first column containing the cell (of N columns it may span)
                // and we want to navigate to the next "real" column
                this.goToColumn(currentColumn + currentCell.colSpan);
                break;
            case "Left": // IE specific value
            case "ArrowLeft":
                event.preventDefault();
                // we only ever need to subtract 1 from the column, since findColumnIndex returns the
                // first of N columns containing the cell
                this.goToColumn(currentColumn - 1);
                break;
            case "Down": // IE specific value
            case "ArrowDown":
                event.preventDefault();
                this.goToRow(currentRow + currentCell.rowSpan);
                break;
            case "Up": // IE specific value
            case "ArrowUp":
                event.preventDefault();
                this.goToRow(currentRow - 1);
                break;
            case "Home":
                event.preventDefault();
                if (event.ctrlKey) {
                    this.goTo({ row: 0, column: 0 });
                }
                else {
                    this.goToColumn(0);
                }
                break;
            case "End":
                event.preventDefault();
                if (event.ctrlKey) {
                    this.goTo({ row: this.lastRow, column: this.lastColumn });
                }
                else {
                    this.goToColumn(this.lastColumn);
                }
                break;
        }
    };
    /**
     * Handles moving the position to the clicked cell
     *
     * @param event the MouseEvent to handle
     */
    DataGridInteractionModel.prototype.handleClickEvent = function (event) {
        var cell = event.target.closest("td, th");
        var _a = tslib_1.__read(this.tableAdapter.findIndex(cell), 2), rowIndex = _a[0], cellIndex = _a[1];
        this.goTo({ row: rowIndex, column: cellIndex });
    };
    /**
     * Jump to a specific column without changing the row
     *
     * @param index column to jump to
     */
    DataGridInteractionModel.prototype.goToColumn = function (index) {
        if (index > this.lastColumn || index < 0) {
            return;
        }
        this.goTo({ row: this.currentRow, column: index });
    };
    /**
     * Jump to a specific row without changing the column
     *
     * @param index row to jump to
     */
    DataGridInteractionModel.prototype.goToRow = function (index) {
        if (index > this.lastRow || index < 0) {
            return;
        }
        this.goTo({ row: index, column: this.currentColumn });
    };
    /**
     * Jump to the specified row and column
     *
     * @param param0 an object that contains `row` and `column` properties
     */
    DataGridInteractionModel.prototype.goTo = function (_a) {
        var row = _a.row, column = _a.column;
        this.rowSubject.next({ current: row, previous: this.currentRow });
        this.columnSubject.next({ current: column, previous: this.currentColumn });
    };
    /**
     * Convenience method to reset the tab indexes on a standard carbon table.
     * For custom tables you may want to reset the indexes manually and simply call `.reset()`
     */
    DataGridInteractionModel.prototype.resetTabIndexes = function (newTabIndex) {
        if (newTabIndex === void 0) { newTabIndex = -1; }
        var e_1, _a;
        for (var i = 0; i < this.tableAdapter.lastRowIndex; i++) {
            var row = this.tableAdapter.getRow(i);
            try {
                for (var _b = tslib_1.__values(Array.from(row.cells)), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var cell = _c.value;
                    var tabbableElements = getFocusElementList(cell, tabbableSelectorIgnoreTabIndex);
                    tabbableElements.forEach(function (node) { return node.tabIndex = newTabIndex; });
                    cell.tabIndex = newTabIndex;
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
        this.reset();
    };
    /**
     * Resets the models focus position
     */
    DataGridInteractionModel.prototype.reset = function () {
        this.rowSubject.next({ current: 0, previous: -1 });
        this.columnSubject.next({ current: 0, previous: -1 });
    };
    return DataGridInteractionModel;
}());
export { DataGridInteractionModel };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1ncmlkLWludGVyYWN0aW9uLW1vZGVsLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vY2FyYm9uLWNvbXBvbmVudHMtYW5ndWxhci90YWJsZS8iLCJzb3VyY2VzIjpbImRhdGEtZ3JpZC1pbnRlcmFjdGlvbi1tb2RlbC5jbGFzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNOLGVBQWUsRUFFZixhQUFhLEVBQ2IsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckMsT0FBTyxFQUFFLDhCQUE4QixFQUFFLG1CQUFtQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFZdkc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0E4Q0c7QUFDSDtJQW1EQzs7Ozs7O09BTUc7SUFDSCxrQ0FDVyxtQkFBOEMsRUFDOUMsZ0JBQXdDLEVBQ3hDLFlBQTBCO1FBRjFCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBMkI7UUFDOUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUF3QjtRQUN4QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQS9DckM7O1dBRUc7UUFDTyxlQUFVLEdBQUcsSUFBSSxlQUFlLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDekU7O1dBRUc7UUFDTyxrQkFBYSxHQUFHLElBQUksZUFBZSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBMEMzRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDL0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3JELElBQUksQ0FBQyxRQUFRLEdB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SSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQSxnQkFBQSw0QkFBRTtvQkFBckMsSUFBTSxJQUFJLFdBQUE7b0JBQ2QsSUFBTSxnQkFBZ0IsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsOEJBQThCLENBQUMsQ0FBQztvQkFDbkYsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFVBQUMsSUFBaUIsSUFBSyxPQUFBLElBQUksQ0FBQyxRQUFRLEdBQUcsV0FBVyxFQUEzQixDQUEyQixDQUFDLENBQUM7b0JBQzdFLElBQUksQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFDO2lCQUM1Qjs7Ozs7Ozs7O1NBQ0Q7UUFFRCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCx3Q0FBSyxHQUFMO1FBQ0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUNGLCtCQUFDO0FBQUQsQ0FBQyxBQXhNRCxJQXdNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdEJlaGF2aW9yU3ViamVjdCxcblx0T2JzZXJ2YWJsZSxcblx0Y29tYmluZUxhdGVzdFxufSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBUYWJsZUFkYXB0ZXIgfSBmcm9tIFwiLi90YWJsZS1hZGFwdGVyLmNsYXNzXCI7XG5pbXBvcnQgeyB0YWJiYWJsZVNlbGVjdG9ySWdub3JlVGFiSW5kZXgsIGdldEZvY3VzRWxlbWVudExpc3QgfSBmcm9tIFwiY2FyYm9uLWNvbXBvbmVudHMtYW5ndWxhci9jb21tb25cIjtcblxuLyoqXG4gKiBUaGUgY3VycmVudCBhbmQgcHJldmlvdXMgcG9zaXRpb24gaW4gdGhlIGdyaWQuXG4gKlxuICogYGN1cnJlbnRgIGFuZCBgcHJldmlvdXNgIGFyZSB0dXBsZXMgdGhhdCBmb2xsb3cgdGhlIGBbcm93LCBjb2x1bW5dYCBjb252ZW50aW9uLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIERhdGFHcmlkUG9zaXRpb24ge1xuXHRjdXJyZW50OiBbbnVtYmVyLCBudW1iZXJdO1xuXHRwcmV2aW91czogW251bWJlciwgbnVtYmVyXTtcbn1cblxuLyoqXG4gKiBgRGF0YUdyaWRJbnRlcmFjdGlvbk1vZGVsYCBwcm92aWRlcyBjZW50cmFsaXplZCBjb250cm9sIG92ZXIgYXJiaXRyYXJ5IDJkIGdyaWRzLCBmb2xsb3dpbmcgdGhlIHczIHNwZWNzLlxuICpcbiAqIFJlZnM6XG4gKiAgLSBodHRwczovL3d3dy53My5vcmcvVFIvd2FpLWFyaWEtcHJhY3RpY2VzL2V4YW1wbGVzL2dyaWQvZGF0YUdyaWRzLmh0bWxcbiAqICAtIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93YWktYXJpYS1wcmFjdGljZXMvI2dyaWRcbiAqXG4gKiBFeGFtcGxlIHVzYWdlICh0YWtlbiBmcm9tIGB0YWJsZS5jb21wb25lbnRgKTpcbmBgYHR5cGVzY3JpcHRcbi8vIGEgc3RhbmRhcmQgSFRNTCB0YWJsZVxuY29uc3QgdGFibGUgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKFwidGFibGVcIikgYXMgSFRNTFRhYmxlRWxlbWVudDtcblxuLy8gYFRhYmxlRG9tQWRhcHRlcmAgaW1wbGVtZW50cyBgVGFibGVBZGFwdGVyYCBhbmQgcHJvdmlkZXMgYSBjb25zaXN0ZW50IGludGVyZmFjZSB0byBxdWVyeSByb3dzIGFuZCBjb2x1bW5zIGluIGEgdGFibGVcbmNvbnN0IHRhYmxlQWRhcHRlciA9IG5ldyBUYWJsZURvbUFkYXB0ZXIodGFibGUpO1xuXG4vLyB0aGUga2V5ZG93biBldmVudHMgdGhhdCB3ZSdsbCB1c2UgZm9yIGtleWJvYXJkIG5hdmlnYXRpb24gb2YgdGhlIHRhYmxlXG5jb25zdCBrZXlkb3duRXZlbnRTdHJlYW0gPSBmcm9tRXZlbnQ8S2V5Ym9hcmRFdmVudD4odGFibGUsIFwia2V5ZG93blwiKTtcblxuLy8gdGhlIGNsaWNrIGV2ZW50cyB3ZSdsbCB1c2UgdG8gZW5zdXJlIGZvY3VzIGlzIHVwZGF0ZWQgY29ycmVjdGx5IG9uIGNsaWNrXG5jb25zdCBjbGlja0V2ZW50U3RyZWFtID0gZnJvbUV2ZW50PE1vdXNlRXZlbnQ+KHRhYmxlLCBcImNsaWNrXCIpO1xuXG4vLyB0aGUgYERhdGFHcmlkSW50ZXJhY3Rpb25Nb2RlbGAgaW5zdGFuY2UhXG50aGlzLmludGVyYWN0aW9uTW9kZWwgPSBuZXcgRGF0YUdyaWRJbnRlcmFjdGlvbk1vZGVsKGtleWRvd25FdmVudFN0cmVhbSwgY2xpY2tFdmVudFN0cmVhbSwgdGFibGVBZGFwdGVyKTtcblxuLy8gc3Vic2NyaWJlIHRvIHRoZSBjb21iaW5lZCBwb3NpdGlvbiB1cGRhdGVzXG50aGlzLmludGVyYWN0aW9uTW9kZWwucG9zaXRpb24uc3Vic2NyaWJlKGV2ZW50ID0+IHtcblx0Y29uc3QgW2N1cnJlbnRSb3csIGN1cnJlbnRDb2x1bW5dID0gZXZlbnQuY3VycmVudDtcblx0Y29uc3QgW3ByZXZpb3VzUm93LCBwcmV2aW91c0NvbHVtbl0gPSBldmVudC5wcmV2aW91cztcblxuXHQvLyBxdWVyeSB0aGUgVGFibGVBZGFwdGVyIGZvciB0aGUgY2VsbCBhdCB0aGUgY3VycmVudCByb3cgYW5kIGNvbHVtbiAuLi5cblx0Y29uc3QgY3VycmVudEVsZW1lbnQgPSB0YWJsZUFkYXB0ZXIuZ2V0Q2VsbChjdXJyZW50Um93LCBjdXJyZW50Q29sdW1uKTtcblx0Ly8gLi4uIGFuZCBtYWtlIGl0IGZvY3VzYWJsZSBpdFxuXHRUYWJsZS5zZXRUYWJJbmRleChjdXJyZW50RWxlbWVudCwgMCk7XG5cblx0Ly8gaWYgdGhlIG1vZGVsIGhhcyBqdXN0IGluaXRpYWxpemVkIGRvbid0IGZvY3VzIG9yIHJlc2V0IGFueXRoaW5nXG5cdGlmIChwcmV2aW91c1JvdyA9PT0gLTEgfHwgcHJldmlvdXNDb2x1bW4gPT09IC0xKSB7IHJldHVybjsgfVxuXG5cdC8vIHF1ZXJ5IHRoZSBUYWJsZUFkYXB0ZXIgZm9yIHRoZSBjZWxsIGF0IHRoZSBwcmV2aW91cyByb3cgYW5kIGNvbHVtbiAuLi5cblx0Y29uc3QgcHJldmlvdXNFbGVtZW50ID0gdGFibGVBZGFwdGVyLmdldENlbGwocHJldmlvdXNSb3csIHByZXZpb3VzQ29sdW1uKTtcblx0Ly8gLi4uIGFuZCBtYWtlIGl0IHVuZm9jdXNhYmxlIChub3cgdGhlcmUgaXMgb25seSBhIHNpbmdsZSBmb2N1c2FibGUgY2VsbClcblx0VGFibGUuc2V0VGFiSW5kZXgocHJldmlvdXNFbGVtZW50LCAtMSk7XG5cblx0Ly8gZmluYWxseSwgZm9jdXMgdGhlIGN1cnJlbnQgY2VsbCAoc2tpcHBlZCBkdXJpbmcgaW5pdGlsemF0aW9uKVxuXHRUYWJsZS5mb2N1cyhjdXJyZW50RWxlbWVudCk7XG59KTtcbmBgYFxuICovXG5leHBvcnQgY2xhc3MgRGF0YUdyaWRJbnRlcmFjdGlvbk1vZGVsIHtcblx0LyoqXG5cdCAqIEFuIE9ic2VydmFibGUgdGhhdCBwcm92aWRlcyBhbiBhZ2dyZWdhdGVkIHZpZXcgb2YgdGhlIGByb3dJbmRleGAgYW5kIGBjb2x1bW5JbmRleGAgT2JzZXJ2YWJsZXNcblx0ICovXG5cdHJlYWRvbmx5IHBvc2l0aW9uOiBPYnNlcnZhYmxlPERhdGFHcmlkUG9zaXRpb24+O1xuXHQvKipcblx0ICogQW4gT2JzZXJ2YWJsZSB0aGF0IHByb3ZpZGVzIHRoZSBjdXJyZW50IGFuZCBwcmV2aW91cyByb3cgaW5kZXhlcy5cblx0ICovXG5cdHJlYWRvbmx5IHJvd0luZGV4OiBPYnNlcnZhYmxlPHsgY3VycmVudDogbnVtYmVyLCBwcmV2aW91czogbnVtYmVyIH0+O1xuXHQvKipcblx0ICogQW4gT2JzZXJ2YWJsZSB0aGF0IHByb3ZpZGVzIHRoZSBjdXJyZW50IGFuZCBwcmV2aW91cyBjb2x1bW4gaW5kZXhlcy5cblx0ICovXG5cdHJlYWRvbmx5IGNvbHVtbkluZGV4OiBPYnNlcnZhYmxlPHsgY3VycmVudDogbnVtYmVyLCBwcmV2aW91czogbnVtYmVyIH0+O1xuXG5cdC8qKlxuXHQgKiBJbnRlcm5hbCBzdWJqZWN0IHRvIGhhbmRsZSBjaGFuZ2VzIGluIHJvd1xuXHQgKi9cblx0cHJvdGVjdGVkIHJvd1N1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHsgY3VycmVudDogMCwgcHJldmlvdXM6IC0xIH0pO1xuXHQvKipcblx0ICogSW50ZXJuYWwgc3ViamVjdCB0byBoYW5kbGUgY2hhbmdlcyBpbiBjb2x1bW5cblx0ICovXG5cdHByb3RlY3RlZCBjb2x1bW5TdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdCh7IGN1cnJlbnQ6IDAsIHByZXZpb3VzOiAtMSB9KTtcblxuXHQvKipcblx0ICogVGhlIGxhdGVzdCB2YWx1ZSBlbWl0dGVkIGJ5IHRoZSByb3dTdWJqZWN0XG5cdCAqL1xuXHRwcm90ZWN0ZWQgZ2V0IGN1cnJlbnRSb3coKSB7XG5cdFx0cmV0dXJuIHRoaXMucm93U3ViamVjdC5nZXRWYWx1ZSgpLmN1cnJlbnQ7XG5cdH1cblxuXHQvKipcblx0ICogVGhlIGxhdGVzdCB2YWx1ZSBlbWl0dGVkIGJ5IHRoZSBjb2x1bW5TdWJqZWN0XG5cdCAqL1xuXHRwcm90ZWN0ZWQgZ2V0IGN1cnJlbnRDb2x1bW4oKSB7XG5cdFx0cmV0dXJuIHRoaXMuY29sdW1uU3ViamVjdC5nZXRWYWx1ZSgpLmN1cnJlbnQ7XG5cdH1cblxuXHQvKipcblx0ICogVGhlIGxhc3QgY29sdW1uIGFzIHJlcG9ydGVkIGJ5IHRoZSBhZGFwdGVyXG5cdCAqL1xuXHRwcm90ZWN0ZWQgZ2V0IGxhc3RDb2x1bW4oKSB7XG5cdFx0cmV0dXJuIHRoaXMudGFibGVBZGFwdGVyLmxhc3RDb2x1bW5JbmRleDtcblx0fVxuXG5cdC8qKlxuXHQgKiBUaGUgbGFzdCByb3cgYXMgcmVwb3J0ZWQgYnkgdGhlIGFkYXB0ZXJcblx0ICovXG5cdHByb3RlY3RlZCBnZXQgbGFzdFJvdygpIHtcblx0XHRyZXR1cm4gdGhpcy50YWJsZUFkYXB0ZXIubGFzdFJvd0luZGV4O1xuXHR9XG5cblx0LyoqXG5cdCAqIGBEYXRhR3JpZEludGVyYWN0aW9uTW9kZWxgIHJlcXVpcmVzIGtub3dsZWRnZSBvZiBldmVudHMsIGFuZCBhIHJlcHJlc2VudGF0aW9uIG9mIHlvdXIgdGFibGUvZ3JpZCB0byBiZSB1c2VmdWwuXG5cdCAqXG5cdCAqIEBwYXJhbSBrZXlib2FyZEV2ZW50U3RyZWFtIGFuIE9ic2VydmFibGUgb2YgS2V5Ym9hcmRFdmVudHMuIFNob3VsZCBiZSBzY29wZWQgdG8gdGhlIHRhYmxlIGNvbnRhaW5lci5cblx0ICogQHBhcmFtIGNsaWNrRXZlbnRTdHJlYW0gYW4gT2JzZXJ2YWJsZSBvZiBDbGlja0V2ZW50cy4gc2hvdWxkIG9ubHkgaW5jbHVkZSBjbGlja3MgdGhhdCB0YWtlIGFjdGlvbiBvbiBpdGVtcyBrbm93biBieSB0aGUgVGFibGVBZGFwdGVyXG5cdCAqIEBwYXJhbSB0YWJsZUFkYXB0ZXIgYW4gaW5zdGFuY2Ugb2YgYSBjb25jcmV0ZSBjbGFzcyB0aGF0IGltcGxlbWVudHMgVGFibGVBZGFwdGVyLiBUaGUgc3RhbmRhcmQgY2FyYm9uIHRhYmxlIHVzZXMgVGFibGVEb21BZGFwdGVyXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcm90ZWN0ZWQga2V5Ym9hcmRFdmVudFN0cmVhbTogT2JzZXJ2YWJsZTxLZXlib2FyZEV2ZW50Pixcblx0XHRwcm90ZWN0ZWQgY2xpY2tFdmVudFN0cmVhbTogT2JzZXJ2YWJsZTxNb3VzZUV2ZW50Pixcblx0XHRwcm90ZWN0ZWQgdGFibGVBZGFwdGVyOiBUYWJsZUFkYXB0ZXJcblx0KSB7XG5cdFx0dGhpcy5yb3dJbmRleCA9IHRoaXMucm93U3ViamVjdC5hc09ic2VydmFibGUoKTtcblx0XHR0aGlzLmNvbHVtbkluZGV4ID0gdGhpcy5jb2x1bW5TdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuXHRcdHRoaXMucG9zaXRpb24gPSBjb21iaW5lTGF0ZXN0KHRoaXMucm93SW5kZXgsIHRoaXMuY29sdW1uSW5kZXgpLnBpcGUobWFwKHBvc2l0aW9ucyA9PiB7XG5cdFx0XHRjb25zdCBbcm93LCBjb2x1bW5dID0gcG9zaXRpb25zO1xuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0Y3VycmVudDogW3Jvdy5jdXJyZW50LCBjb2x1bW4uY3VycmVudF0sXG5cdFx0XHRcdHByZXZpb3VzOiBbcm93LnByZXZpb3VzLCBjb2x1bW4ucHJldmlvdXNdXG5cdFx0XHR9O1xuXHRcdH0pKSBhcyBPYnNlcnZhYmxlPERhdGFHcmlkUG9zaXRpb24+O1xuXHRcdHRoaXMua2V5Ym9hcmRFdmVudFN0cmVhbS5zdWJzY3JpYmUodGhpcy5oYW5kbGVLZXlib2FyZEV2ZW50LmJpbmQodGhpcykpO1xuXHRcdHRoaXMuY2xpY2tFdmVudFN0cmVhbS5zdWJzY3JpYmUodGhpcy5oYW5kbGVDbGlja0V2ZW50LmJpbmQodGhpcykpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhhbmRsZXMgbW92aW5nIHRoZSBwb3NpdGlvbiBhY2NvcmRpbmcgdG8gdGhlIHczIGRhdGFncmlkIG5hdmlnYXRpb24gc3BlY3Ncblx0ICpcblx0ICogUmVmczpcblx0ICogIC0gaHR0cHM6Ly93d3cudzMub3JnL1RSL3dhaS1hcmlhLXByYWN0aWNlcy9leGFtcGxlcy9ncmlkL2RhdGFHcmlkcy5odG1sXG5cdCAqICAtIGh0dHBzOi8vd3d3LnczLm9yZy9UUi93YWktYXJpYS1wcmFjdGljZXMvI2dyaWRcblx0ICpcblx0ICogQHBhcmFtIGV2ZW50IHRoZSBLZXlib2FyZEV2ZW50IHRvIGhhbmRsZVxuXHQgKi9cblx0aGFuZGxlS2V5Ym9hcmRFdmVudChldmVudDogS2V5Ym9hcmRFdmVudCkge1xuXHRcdGNvbnN0IGN1cnJlbnRDZWxsID0gdGhpcy50YWJsZUFkYXB0ZXIuZ2V0Q2VsbCh0aGlzLmN1cnJlbnRSb3csIHRoaXMuY3VycmVudENvbHVtbik7XG5cdFx0bGV0IGN1cnJlbnRDb2x1bW4gPSB0aGlzLnRhYmxlQWRhcHRlci5maW5kQ29sdW1uSW5kZXgoY3VycmVudENlbGwpO1xuXHRcdGxldCBjdXJyZW50Um93ID0gdGhpcy50YWJsZUFkYXB0ZXIuZmluZFJvd0luZGV4KGN1cnJlbnRDZWxsKTtcblxuXHRcdHN3aXRjaCAoZXZlbnQua2V5KSB7XG5cdFx0XHRjYXNlIFwiUmlnaHRcIjogLy8gSUUgc3BlY2lmaWMgdmFsdWVcblx0XHRcdGNhc2UgXCJBcnJvd1JpZ2h0XCI6XG5cdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdC8vIGFkZCB0aGUgY29sc3BhbiBzaW5jZSBmaW5kQ29sdW1uSW5kZXggd2lsbCByZXR1cm4gdGhlXG5cdFx0XHRcdC8vIGZpcnN0IGNvbHVtbiBjb250YWluaW5nIHRoZSBjZWxsIChvZiBOIGNvbHVtbnMgaXQgbWF5IHNwYW4pXG5cdFx0XHRcdC8vIGFuZCB3ZSB3YW50IHRvIG5hdmlnYXRlIHRvIHRoZSBuZXh0IFwicmVhbFwiIGNvbHVtblxuXHRcdFx0XHR0aGlzLmdvVG9Db2x1bW4oY3VycmVudENvbHVtbiArIGN1cnJlbnRDZWxsLmNvbFNwYW4pO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgXCJMZWZ0XCI6IC8vIElFIHNwZWNpZmljIHZhbHVlXG5cdFx0XHRjYXNlIFwiQXJyb3dMZWZ0XCI6XG5cdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdC8vIHdlIG9ubHkgZXZlciBuZWVkIHRvIHN1YnRyYWN0IDEgZnJvbSB0aGUgY29sdW1uLCBzaW5jZSBmaW5kQ29sdW1uSW5kZXggcmV0dXJucyB0aGVcblx0XHRcdFx0Ly8gZmlyc3Qgb2YgTiBjb2x1bW5zIGNvbnRhaW5pbmcgdGhlIGNlbGxcblx0XHRcdFx0dGhpcy5nb1RvQ29sdW1uKGN1cnJlbnRDb2x1bW4gLSAxKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIFwiRG93blwiOiAvLyBJRSBzcGVjaWZpYyB2YWx1ZVxuXHRcdFx0Y2FzZSBcIkFycm93RG93blwiOlxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0XHR0aGlzLmdvVG9Sb3coY3VycmVudFJvdyArIGN1cnJlbnRDZWxsLnJvd1NwYW4pO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgXCJVcFwiOiAvLyBJRSBzcGVjaWZpYyB2YWx1ZVxuXHRcdFx0Y2FzZSBcIkFycm93VXBcIjpcblx0XHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0dGhpcy5nb1RvUm93KGN1cnJlbnRSb3cgLSAxKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIFwiSG9tZVwiOlxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0XHRpZiAoZXZlbnQuY3RybEtleSkge1xuXHRcdFx0XHRcdHRoaXMuZ29Ubyh7cm93OiAwLCBjb2x1bW46IDB9KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR0aGlzLmdvVG9Db2x1bW4oMCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIFwiRW5kXCI6XG5cdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdGlmIChldmVudC5jdHJsS2V5KSB7XG5cdFx0XHRcdFx0dGhpcy5nb1RvKHsgcm93OiB0aGlzLmxhc3RSb3csIGNvbHVtbjogdGhpcy5sYXN0Q29sdW1uIH0pO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRoaXMuZ29Ub0NvbHVtbih0aGlzLmxhc3RDb2x1bW4pO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBIYW5kbGVzIG1vdmluZyB0aGUgcG9zaXRpb24gdG8gdGhlIGNsaWNrZWQgY2VsbFxuXHQgKlxuXHQgKiBAcGFyYW0gZXZlbnQgdGhlIE1vdXNlRXZlbnQgdG8gaGFuZGxlXG5cdCAqL1xuXHRoYW5kbGVDbGlja0V2ZW50KGV2ZW50OiBNb3VzZUV2ZW50KSB7XG5cdFx0Y29uc3QgY2VsbCA9IChldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQpLmNsb3Nlc3QoXCJ0ZCwgdGhcIikgYXMgSFRNTFRhYmxlQ2VsbEVsZW1lbnQ7XG5cdFx0Y29uc3QgW3Jvd0luZGV4LCBjZWxsSW5kZXhdID0gdGhpcy50YWJsZUFkYXB0ZXIuZmluZEluZGV4KGNlbGwpO1xuXHRcdHRoaXMuZ29Ubyh7IHJvdzogcm93SW5kZXgsIGNvbHVtbjogY2VsbEluZGV4IH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIEp1bXAgdG8gYSBzcGVjaWZpYyBjb2x1bW4gd2l0aG91dCBjaGFuZ2luZyB0aGUgcm93XG5cdCAqXG5cdCAqIEBwYXJhbSBpbmRleCBjb2x1bW4gdG8ganVtcCB0b1xuXHQgKi9cblx0Z29Ub0NvbHVtbihpbmRleDogbnVtYmVyKSB7XG5cdFx0aWYgKGluZGV4ID4gdGhpcy5sYXN0Q29sdW1uIHx8IGluZGV4IDwgMCkgeyByZXR1cm47IH1cblx0XHR0aGlzLmdvVG8oeyByb3c6IHRoaXMuY3VycmVudFJvdywgY29sdW1uOiBpbmRleH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIEp1bXAgdG8gYSBzcGVjaWZpYyByb3cgd2l0aG91dCBjaGFuZ2luZyB0aGUgY29sdW1uXG5cdCAqXG5cdCAqIEBwYXJhbSBpbmRleCByb3cgdG8ganVtcCB0b1xuXHQgKi9cblx0Z29Ub1JvdyhpbmRleDogbnVtYmVyKSB7XG5cdFx0aWYgKGluZGV4ID4gdGhpcy5sYXN0Um93IHx8IGluZGV4IDwgMCkgeyByZXR1cm47IH1cblx0XHR0aGlzLmdvVG8oe3JvdzogaW5kZXgsIGNvbHVtbjogdGhpcy5jdXJyZW50Q29sdW1ufSk7XG5cdH1cblxuXHQvKipcblx0ICogSnVtcCB0byB0aGUgc3BlY2lmaWVkIHJvdyBhbmQgY29sdW1uXG5cdCAqXG5cdCAqIEBwYXJhbSBwYXJhbTAgYW4gb2JqZWN0IHRoYXQgY29udGFpbnMgYHJvd2AgYW5kIGBjb2x1bW5gIHByb3BlcnRpZXNcblx0ICovXG5cdGdvVG8oe3JvdywgY29sdW1ufSkge1xuXHRcdHRoaXMucm93U3ViamVjdC5uZXh0KHsgY3VycmVudDogcm93LCBwcmV2aW91czogdGhpcy5jdXJyZW50Um93IH0pO1xuXHRcdHRoaXMuY29sdW1uU3ViamVjdC5uZXh0KHsgY3VycmVudDogY29sdW1uLCBwcmV2aW91czogdGhpcy5jdXJyZW50Q29sdW1uIH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIENvbnZlbmllbmNlIG1ldGhvZCB0byByZXNldCB0aGUgdGFiIGluZGV4ZXMgb24gYSBzdGFuZGFyZCBjYXJib24gdGFibGUuXG5cdCAqIEZvciBjdXN0b20gdGFibGVzIHlvdSBtYXkgd2FudCB0byByZXNldCB0aGUgaW5kZXhlcyBtYW51YWxseSBhbmQgc2ltcGx5IGNhbGwgYC5yZXNldCgpYFxuXHQgKi9cblx0cmVzZXRUYWJJbmRleGVzKG5ld1RhYkluZGV4ID0gLTEpIHtcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudGFibGVBZGFwdGVyLmxhc3RSb3dJbmRleDsgaSsrKSB7XG5cdFx0XHRjb25zdCByb3cgPSB0aGlzLnRhYmxlQWRhcHRlci5nZXRSb3coaSkgYXMgSFRNTFRhYmxlUm93RWxlbWVudDtcblx0XHRcdGZvciAoY29uc3QgY2VsbCBvZiBBcnJheS5mcm9tKHJvdy5jZWxscykpIHtcblx0XHRcdFx0Y29uc3QgdGFiYmFibGVFbGVtZW50cyA9IGdldEZvY3VzRWxlbWVudExpc3QoY2VsbCwgdGFiYmFibGVTZWxlY3Rvcklnbm9yZVRhYkluZGV4KTtcblx0XHRcdFx0dGFiYmFibGVFbGVtZW50cy5mb3JFYWNoKChub2RlOiBIVE1MRWxlbWVudCkgPT4gbm9kZS50YWJJbmRleCA9IG5ld1RhYkluZGV4KTtcblx0XHRcdFx0Y2VsbC50YWJJbmRleCA9IG5ld1RhYkluZGV4O1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHRoaXMucmVzZXQoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXNldHMgdGhlIG1vZGVscyBmb2N1cyBwb3NpdGlvblxuXHQgKi9cblx0cmVzZXQoKSB7XG5cdFx0dGhpcy5yb3dTdWJqZWN0Lm5leHQoeyBjdXJyZW50OiAwLCBwcmV2aW91czogLTEgfSk7XG5cdFx0dGhpcy5jb2x1bW5TdWJqZWN0Lm5leHQoeyBjdXJyZW50OiAwLCBwcmV2aW91czogLTEgfSk7XG5cdH1cbn1cbiJdfQ==