/**
 *
 * carbon-angular v0.0.0 | dropdown.service.js
 *
 * Copyright 2014, 2021 IBM
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0

 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


import { Injectable } from "@angular/core";
import { PlaceholderService } from "carbon-components-angular/placeholder";
import { Subscription } from "rxjs";
import { position } from "@carbon/utils-position";
import { AnimationFrameService } from "carbon-components-angular/utils";
import { closestAttr } from "carbon-components-angular/utils";
var defaultOffset = { top: 0, left: 0 };
var DropdownService = /** @class */ (function () {
    function DropdownService(placeholderService, animationFrameService) {
        this.placeholderService = placeholderService;
        this.animationFrameService = animationFrameService;
        /**
         * Maintains an Event Observable Subscription for the global requestAnimationFrame.
         * requestAnimationFrame is tracked only if the `Dropdown` is appended to the body otherwise we don't need it
         */
        this.animationFrameSubscription = new Subscription();
        this._offset = defaultOffset;
    }
    Object.defineProperty(DropdownService.prototype, "offset", {
        get: function () {
            return this._offset;
        },
        set: function (value) {
            this._offset = Object.assign({}, defaultOffset, value);
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Appends the menu to the body, or a `ibm-placeholder` (if defined)
     *
     * @param parentRef container to position relative to
     * @param menuRef menu to be appended to body
     * @param classList any extra classes we should wrap the container with
     */
    DropdownService.prototype.appendToBody = function (parentRef, menuRef, classList) {
        var _this = this;
        // build the dropdown list container
        menuRef.style.display = "block";
        var dropdownWrapper = document.createElement("div");
        dropdownWrapper.className = "dropdown " + classList;
        dropdownWrapper.style.width = parentRef.offsetWidth + "px";
        dropdownWrapper.style.position = "absolute";
        dropdownWrapper.appendChild(menuRef);
        // append it to the placeholder
        if (this.placeholderService.hasPlaceholderRef()) {
            this.placeholderService.appendElement(dropdownWrapper);
            // or append it directly to the body
        }
        else {
            document.body.appendChild(dropdownWrapper);
        }
        this.menuInstance = dropdownWrapper;
        this.animationFrameSubscription = this.animationFrameService.tick.subscribe(function () {
            _this.positionDropdown(parentRef, dropdownWrapper);
        });
        // run one position in sync, so we're less likely to have the view "jump" as we focus
        this.positionDropdown(parentRef, dropdownWrapper);
        return dropdownWrapper;
    };
    /**
     * Reattach the dropdown menu to the parent container
     * @param hostRef container to append to
     */
    DropdownService.prototype.appendToDropdown = function (hostRef) {
        // if the instance is already removed don't try and remove it again
        if (!this.menuInstance) {
            return;
        }
        var instance = this.menuInstance;
        var menu = instance.firstElementChild;
        // clean up the instance
        this.menuInstance = null;
        menu.style.display = "none";
        hostRef.appendChild(menu);
        this.animationFrameSubscription.unsubscribe();
        if (this.placeholderService.hasPlaceholderRef() && this.placeholderService.hasElement(instance)) {
            this.placeholderService.removeElement(instance);
        }
        else if (document.body.contains(instance)) {
            document.body.removeChild(instance);
        }
        return instance;
    };
    /**
     * position an open dropdown relative to the given parentRef
     */
    DropdownService.prototype.updatePosition = function (parentRef) {
        this.positionDropdown(parentRef, this.menuInstance);
    };
    DropdownService.prototype.ngOnDestroy = function () {
        this.animationFrameSubscription.unsubscribe();
    };
    DropdownService.prototype.positionDropdown = function (parentRef, menuRef) {
        if (!menuRef) {
            return;
        }
        var leftOffset = 0;
        var boxMenu = menuRef.querySelector(".bx--list-box__menu");
        if (boxMenu) {
            // If the parentRef and boxMenu are in a different left position relative to the
            // window, the the boxMenu position has already been flipped and a check needs to be done
            // to see if it needs to stay flipped.
            if (parentRef.getBoundingClientRect().left !== boxMenu.getBoundingClientRect().left) {
                // The getBoundingClientRect().right of the boxMenu if it were hypothetically flipped
                // back into the original position before the flip.
                var testBoxMenuRightEdgePos = parentRef.getBoundingClientRect().left - boxMenu.getBoundingClientRect().left + boxMenu.getBoundingClientRect().right;
                if (testBoxMenuRightEdgePos > (window.innerWidth || document.documentElement.clientWidth)) {
                    leftOffset = parentRef.offsetWidth - boxMenu.offsetWidth;
                }
                // If it has not already been flipped, check if it is necessary to flip, ie. if the
                // boxMenu is outside of the right viewPort.
            }
            else if (boxMenu.getBoundingClientRect().right > (window.innerWidth || document.documentElement.clientWidth)) {
                leftOffset = parentRef.offsetWidth - boxMenu.offsetWidth;
            }
        }
        // If ibm-placeholder has a parent with a position(relative|fixed|absolute) account for the parent offset
        var closestMenuWithPos = closestAttr("position", ["relative", "fixed", "absolute"], menuRef.parentElement);
        var topPos = closestMenuWithPos ? closestMenuWithPos.getBoundingClientRect().top * -1 : this.offset.top;
        var leftPos = closestMenuWithPos ? closestMenuWithPos.getBoundingClientRect().left * -1 : this.offset.left + leftOffset;
        var pos = position.findAbsolute(parentRef, menuRef, "bottom");
        pos = position.addOffset(pos, topPos, leftPos);
        position.setElement(menuRef, pos);
    };
    DropdownService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    DropdownService.ctorParameters = function () { return [
        { type: PlaceholderService },
        { type: AnimationFrameService }
    ]; };
    return DropdownService;
}());
export { DropdownService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2NhcmJvbi1jb21wb25lbnRzLWFuZ3VsYXIvZHJvcGRvd24vIiwic291cmNlcyI6WyJkcm9wZG93bi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQXlCLE1BQU0sZUFBZSxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2xELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUU5RCxJQUFNLGFBQWEsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO0FBRTFDO0lBc0JDLHlCQUNXLGtCQUFzQyxFQUN0QyxxQkFBNEM7UUFENUMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QywwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBVnZEOzs7V0FHRztRQUNPLCtCQUEwQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFaEQsWUFBTyxHQUFHLGFBQWEsQ0FBQztJQUsvQixDQUFDO0lBdkJKLHNCQUFXLG1DQUFNO2FBSWpCO1lBQ0MsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ3JCLENBQUM7YUFORCxVQUFrQixLQUFzQztZQUN2RCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4RCxDQUFDOzs7T0FBQTtJQXVCRDs7Ozs7O09BTUc7SUFDSCxzQ0FBWSxHQUFaLFVBQWEsU0FBc0IsRUFB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Q0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUMxRyxJQUFNLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHLFVBQVUsQ0FBQztRQUUxSCxJQUFJLEdBQUcsR0FBRyxRQUFRLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDOUQsR0FBRyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUUvQyxRQUFRLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNuQyxDQUFDOztnQkF0SUQsVUFBVTs7OztnQkFSRixrQkFBa0I7Z0JBR2xCLHFCQUFxQjs7SUE0STlCLHNCQUFDO0NBQUEsQUF2SUQsSUF1SUM7U0F0SVksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEVsZW1lbnRSZWYsIE9uRGVzdHJveSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBQbGFjZWhvbGRlclNlcnZpY2UgfSBmcm9tIFwiY2FyYm9uLWNvbXBvbmVudHMtYW5ndWxhci9wbGFjZWhvbGRlclwiO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7IHBvc2l0aW9uIH0gZnJvbSBcIkBjYXJib24vdXRpbHMtcG9zaXRpb25cIjtcbmltcG9ydCB7IEFuaW1hdGlvbkZyYW1lU2VydmljZSB9IGZyb20gXCJjYXJib24tY29tcG9uZW50cy1hbmd1bGFyL3V0aWxzXCI7XG5pbXBvcnQgeyBjbG9zZXN0QXR0ciB9IGZyb20gXCJjYXJib24tY29tcG9uZW50cy1hbmd1bGFyL3V0aWxzXCI7XG5cbmNvbnN0IGRlZmF1bHRPZmZzZXQgPSB7IHRvcDogMCwgbGVmdDogMCB9O1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRHJvcGRvd25TZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcblx0cHVibGljIHNldCBvZmZzZXQodmFsdWU6IHsgdG9wPzogbnVtYmVyLCBsZWZ0PzogbnVtYmVyIH0pIHtcblx0XHR0aGlzLl9vZmZzZXQgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0T2Zmc2V0LCB2YWx1ZSk7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IG9mZnNldCgpIHtcblx0XHRyZXR1cm4gdGhpcy5fb2Zmc2V0O1xuXHR9XG5cdC8qKlxuXHQgKiByZWZlcmVuY2UgdG8gdGhlIGJvZHkgYXBwZW5kZWQgbWVudVxuXHQgKi9cblx0cHJvdGVjdGVkIG1lbnVJbnN0YW5jZTogSFRNTEVsZW1lbnQ7XG5cblx0LyoqXG5cdCAqIE1haW50YWlucyBhbiBFdmVudCBPYnNlcnZhYmxlIFN1YnNjcmlwdGlvbiBmb3IgdGhlIGdsb2JhbCByZXF1ZXN0QW5pbWF0aW9uRnJhbWUuXG5cdCAqIHJlcXVlc3RBbmltYXRpb25GcmFtZSBpcyB0cmFja2VkIG9ubHkgaWYgdGhlIGBEcm9wZG93bmAgaXMgYXBwZW5kZWQgdG8gdGhlIGJvZHkgb3RoZXJ3aXNlIHdlIGRvbid0IG5lZWQgaXRcblx0ICovXG5cdHByb3RlY3RlZCBhbmltYXRpb25GcmFtZVN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuXHRwcm90ZWN0ZWQgX29mZnNldCA9IGRlZmF1bHRPZmZzZXQ7XG5cblx0Y29uc3RydWN0b3IoXG5cdFx0cHJvdGVjdGVkIHBsYWNlaG9sZGVyU2VydmljZTogUGxhY2Vob2xkZXJTZXJ2aWNlLFxuXHRcdHByb3RlY3RlZCBhbmltYXRpb25GcmFtZVNlcnZpY2U6IEFuaW1hdGlvbkZyYW1lU2VydmljZVxuXHQpIHt9XG5cblx0LyoqXG5cdCAqIEFwcGVuZHMgdGhlIG1lbnUgdG8gdGhlIGJvZHksIG9yIGEgYGlibS1wbGFjZWhvbGRlcmAgKGlmIGRlZmluZWQpXG5cdCAqXG5cdCAqIEBwYXJhbSBwYXJlbnRSZWYgY29udGFpbmVyIHRvIHBvc2l0aW9uIHJlbGF0aXZlIHRvXG5cdCAqIEBwYXJhbSBtZW51UmVmIG1lbnUgdG8gYmUgYXBwZW5kZWQgdG8gYm9keVxuXHQgKiBAcGFyYW0gY2xhc3NMaXN0IGFueSBleHRyYSBjbGFzc2VzIHdlIHNob3VsZCB3cmFwIHRoZSBjb250YWluZXIgd2l0aFxuXHQgKi9cblx0YXBwZW5kVG9Cb2R5KHBhcmVudFJlZjogSFRNTEVsZW1lbnQsIG1lbnVSZWY6IEhUTUxFbGVtZW50LCBjbGFzc0xpc3QpOiBIVE1MRWxlbWVudCB7XG5cdFx0Ly8gYnVpbGQgdGhlIGRyb3Bkb3duIGxpc3QgY29udGFpbmVyXG5cdFx0bWVudVJlZi5zdHlsZS5kaXNwbGF5ID0gXCJibG9ja1wiO1xuXHRcdGNvbnN0IGRyb3Bkb3duV3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG5cdFx0ZHJvcGRvd25XcmFwcGVyLmNsYXNzTmFtZSA9IGBkcm9wZG93biAke2NsYXNzTGlzdH1gO1xuXHRcdGRyb3Bkb3duV3JhcHBlci5zdHlsZS53aWR0aCA9IHBhcmVudFJlZi5vZmZzZXRXaWR0aCArIFwicHhcIjtcblx0XHRkcm9wZG93bldyYXBwZXIuc3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XG5cdFx0ZHJvcGRvd25XcmFwcGVyLmFwcGVuZENoaWxkKG1lbnVSZWYpO1xuXG5cdFx0Ly8gYXBwZW5kIGl0IHRvIHRoZSBwbGFjZWhvbGRlclxuXHRcdGlmICh0aGlzLnBsYWNlaG9sZGVyU2VydmljZS5oYXNQbGFjZWhvbGRlclJlZigpKSB7XG5cdFx0XHR0aGlzLnBsYWNlaG9sZGVyU2VydmljZS5hcHBlbmRFbGVtZW50KGRyb3Bkb3duV3JhcHBlcik7XG5cdFx0XHQvLyBvciBhcHBlbmQgaXQgZGlyZWN0bHkgdG8gdGhlIGJvZHlcblx0XHR9IGVsc2Uge1xuXHRcdFx0ZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkcm9wZG93bldyYXBwZXIpO1xuXHRcdH1cblxuXHRcdHRoaXMubWVudUluc3RhbmNlID0gZHJvcGRvd25XcmFwcGVyO1xuXG5cdFx0dGhpcy5hbmltYXRpb25GcmFtZVN1YnNjcmlwdGlvbiA9IHRoaXMuYW5pbWF0aW9uRnJhbWVTZXJ2aWNlLnRpY2suc3Vic2NyaWJlKCgpID0+IHtcblx0XHRcdHRoaXMucG9zaXRpb25Ecm9wZG93bihwYXJlbnRSZWYsIGRyb3Bkb3duV3JhcHBlcik7XG5cdFx0fSk7XG5cblx0XHQvLyBydW4gb25lIHBvc2l0aW9uIGluIHN5bmMsIHNvIHdlJ3JlIGxlc3MgbGlrZWx5IHRvIGhhdmUgdGhlIHZpZXcgXCJqdW1wXCIgYXMgd2UgZm9jdXNcblx0XHR0aGlzLnBvc2l0aW9uRHJvcGRvd24ocGFyZW50UmVmLCBkcm9wZG93bldyYXBwZXIpO1xuXG5cdFx0cmV0dXJuIGRyb3Bkb3duV3JhcHBlcjtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZWF0dGFjaCB0aGUgZHJvcGRvd24gbWVudSB0byB0aGUgcGFyZW50IGNvbnRhaW5lclxuXHQgKiBAcGFyYW0gaG9zdFJlZiBjb250YWluZXIgdG8gYXBwZW5kIHRvXG5cdCAqL1xuXHRhcHBlbmRUb0Ryb3Bkb3duKGhvc3RSZWY6IEhUTUxFbGVtZW50KTogSFRNTEVsZW1lbnQge1xuXHRcdC8vIGlmIHRoZSBpbnN0YW5jZSBpcyBhbHJlYWR5IHJlbW92ZWQgZG9uJ3QgdHJ5IGFuZCByZW1vdmUgaXQgYWdhaW5cblx0XHRpZiAoIXRoaXMubWVudUluc3RhbmNlKSB7IHJldHVybjsgfVxuXHRcdGNvbnN0IGluc3RhbmNlID0gdGhpcy5tZW51SW5zdGFuY2U7XG5cdFx0Y29uc3QgbWVudSA9IGluc3RhbmNlLmZpcnN0RWxlbWVudENoaWxkIGFzIEhUTUxFbGVtZW50O1xuXHRcdC8vIGNsZWFuIHVwIHRoZSBpbnN0YW5jZVxuXHRcdHRoaXMubWVudUluc3RhbmNlID0gbnVsbDtcblx0XHRtZW51LnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcblx0XHRob3N0UmVmLmFwcGVuZENoaWxkKG1lbnUpO1xuXHRcdHRoaXMuYW5pbWF0aW9uRnJhbWVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcblx0XHRpZiAodGhpcy5wbGFjZWhvbGRlclNlcnZpY2UuaGFzUGxhY2Vob2xkZXJSZWYoKSAmJiB0aGlzLnBsYWNlaG9sZGVyU2VydmljZS5oYXNFbGVtZW50KGluc3RhbmNlKSkge1xuXHRcdFx0dGhpcy5wbGFjZWhvbGRlclNlcnZpY2UucmVtb3ZlRWxlbWVudChpbnN0YW5jZSk7XG5cdFx0fSBlbHNlIGlmIChkb2N1bWVudC5ib2R5LmNvbnRhaW5zKGluc3RhbmNlKSkge1xuXHRcdFx0ZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChpbnN0YW5jZSk7XG5cdFx0fVxuXHRcdHJldHVybiBpbnN0YW5jZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBwb3NpdGlvbiBhbiBvcGVuIGRyb3Bkb3duIHJlbGF0aXZlIHRvIHRoZSBnaXZlbiBwYXJlbnRSZWZcblx0ICovXG5cdHVwZGF0ZVBvc2l0aW9uKHBhcmVudFJlZikge1xuXHRcdHRoaXMucG9zaXRpb25Ecm9wZG93bihwYXJlbnRSZWYsIHRoaXMubWVudUluc3RhbmNlKTtcblx0fVxuXG5cdG5nT25EZXN0cm95KCkge1xuXHRcdHRoaXMuYW5pbWF0aW9uRnJhbWVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcblx0fVxuXG5cdHByb3RlY3RlZCBwb3NpdGlvbkRyb3Bkb3duKHBhcmVudFJlZiwgbWVudVJlZikge1xuXHRcdGlmICghbWVudVJlZikge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGxldCBsZWZ0T2Zmc2V0ID0gMDtcblxuXHRcdGNvbnN0IGJveE1lbnUgPSBtZW51UmVmLnF1ZXJ5U2VsZWN0b3IoXCIuYngtLWxpc3QtYm94X19tZW51XCIpO1xuXG5cdFx0aWYgKGJveE1lbnUpIHtcblx0XHRcdC8vIElmIHRoZSBwYXJlbnRSZWYgYW5kIGJveE1lbnUgYXJlIGluIGEgZGlmZmVyZW50IGxlZnQgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlXG5cdFx0XHQvLyB3aW5kb3csIHRoZSB0aGUgYm94TWVudSBwb3NpdGlvbiBoYXMgYWxyZWFkeSBiZWVuIGZsaXBwZWQgYW5kIGEgY2hlY2sgbmVlZHMgdG8gYmUgZG9uZVxuXHRcdFx0Ly8gdG8gc2VlIGlmIGl0IG5lZWRzIHRvIHN0YXkgZmxpcHBlZC5cblx0XHRcdGlmIChwYXJlbnRSZWYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCAhPT0gYm94TWVudS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0KSB7XG5cdFx0XHRcdC8vIFRoZSBnZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5yaWdodCBvZiB0aGUgYm94TWVudSBpZiBpdCB3ZXJlIGh5cG90aGV0aWNhbGx5IGZsaXBwZWRcblx0XHRcdFx0Ly8gYmFjayBpbnRvIHRoZSBvcmlnaW5hbCBwb3NpdGlvbiBiZWZvcmUgdGhlIGZsaXAuXG5cdFx0XHRcdGNvbnN0IHRlc3RCb3hNZW51UmlnaHRFZGdlUG9zID1cblx0XHRcdFx0XHRwYXJlbnRSZWYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCAtIGJveE1lbnUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCArIGJveE1lbnUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkucmlnaHQ7XG5cblx0XHRcdFx0aWYgKHRlc3RCb3hNZW51UmlnaHRFZGdlUG9zID4gKHdpbmRvdy5pbm5lcldpZHRoIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCkpIHtcblx0XHRcdFx0XHRsZWZ0T2Zmc2V0ID0gcGFyZW50UmVmLm9mZnNldFdpZHRoIC0gYm94TWVudS5vZmZzZXRXaWR0aDtcblx0XHRcdFx0fVxuXHRcdFx0Ly8gSWYgaXQgaGFzIG5vdCBhbHJlYWR5IGJlZW4gZmxpcHBlZCwgY2hlY2sgaWYgaXQgaXMgbmVjZXNzYXJ5IHRvIGZsaXAsIGllLiBpZiB0aGVcblx0XHRcdC8vIGJveE1lbnUgaXMgb3V0c2lkZSBvZiB0aGUgcmlnaHQgdmlld1BvcnQuXG5cdFx0XHR9IGVsc2UgaWYgKGJveE1lbnUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkucmlnaHQgPiAod2luZG93LmlubmVyV2lkdGggfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoKSkge1xuXHRcdFx0XHRsZWZ0T2Zmc2V0ID0gcGFyZW50UmVmLm9mZnNldFdpZHRoIC0gYm94TWVudS5vZmZzZXRXaWR0aDtcblx0XHRcdH1cblx0XHR9XG5cblx0XHQvLyBJZiBpYm0tcGxhY2Vob2xkZXIgaGFzIGEgcGFyZW50IHdpdGggYSBwb3NpdGlvbihyZWxhdGl2ZXxmaXhlZHxhYnNvbHV0ZSkgYWNjb3VudCBmb3IgdGhlIHBhcmVudCBvZmZzZXRcblx0XHRjb25zdCBjbG9zZXN0TWVudVdpdGhQb3MgPSBjbG9zZXN0QXR0cihcInBvc2l0aW9uXCIsIFtcInJlbGF0aXZlXCIsIFwiZml4ZWRcIiwgXCJhYnNvbHV0ZVwiXSwgbWVudVJlZi5wYXJlbnRFbGVtZW50KTtcblx0XHRjb25zdCB0b3BQb3MgPSBjbG9zZXN0TWVudVdpdGhQb3MgPyBjbG9zZXN0TWVudVdpdGhQb3MuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wICogLTEgOiB0aGlzLm9mZnNldC50b3A7XG5cdFx0Y29uc3QgbGVmdFBvcyA9IGNsb3Nlc3RNZW51V2l0aFBvcyA/IGNsb3Nlc3RNZW51V2l0aFBvcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0ICogLTEgOiB0aGlzLm9mZnNldC5sZWZ0ICsgbGVmdE9mZnNldDtcblxuXHRcdGxldCBwb3MgPSBwb3NpdGlvbi5maW5kQWJzb2x1dGUocGFyZW50UmVmLCBtZW51UmVmLCBcImJvdHRvbVwiKTtcblx0XHRwb3MgPSBwb3NpdGlvbi5hZGRPZmZzZXQocG9zLCB0b3BQb3MsIGxlZnRQb3MpO1xuXG5cdFx0cG9zaXRpb24uc2V0RWxlbWVudChtZW51UmVmLCBwb3MpO1xuXHR9XG59XG4iXX0=