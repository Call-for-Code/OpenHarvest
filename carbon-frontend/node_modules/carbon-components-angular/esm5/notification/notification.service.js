/**
 *
 * carbon-angular v0.0.0 | notification.service.js
 *
 * Copyright 2014, 2021 IBM
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0

 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


import { ApplicationRef, ComponentFactoryResolver, EventEmitter, Injectable, Injector, NgZone } from "@angular/core";
import { Notification } from "./notification.component";
import { Toast } from "./toast.component";
/**
 * Provides a way to use the notification component.
 *
 * Notifications are displayed toward the top of the UI and do not interrupt the userâ€™s work.
 */
var NotificationService = /** @class */ (function () {
    /**
     * Constructs NotificationService.
     *
     * @param injector
     * @param componentFactoryResolver
     * @param applicationRef
     */
    function NotificationService(injector, componentFactoryResolver, applicationRef, ngZone) {
        this.injector = injector;
        this.componentFactoryResolver = componentFactoryResolver;
        this.applicationRef = applicationRef;
        this.ngZone = ngZone;
        /**
         * An array containing `ComponentRef`s to all the notifications this service instance
         * is responsible for.
         *
         */
        this.notificationRefs = new Array();
        this.onClose = new EventEmitter();
    }
    /**
     * Shows the notification based on the `notificationObj`.
     *
     * @param notificationObj Can have `type`, `message`, `target`, `duration` and `smart` members.
     *
     * **Members:**
     *
     * * `type` can be one of `"info"`, `"warning"`, `"danger"`, `"success"`
     * * `message` is message for notification to display
     * * `target` is css selector defining an element to append notification to. If not provided,
     * `showNotification()` creates a place for the notification in `body`
     * * `duration` is number of ms to close the notification after. If used in combination with `smart`,
     * it's added to the calculated timeout
     * * `smart`, set to `true` if you want to use smart notification.
     *
     * **Example:**
     * ```typescript
     * // Info notification, saying "Sample message." added to the element with id notification-container
     * // uses smart timeout with added duration of 1 second.
     * {
     *	type: "info",
     *	message: "Sample message.",
     *	target: "#notification-container",
     *	duration: 1000,
     *	smart: true
     * }
     * ```
     *
     * @param [notificationComp=Notification] If provided, used to resolve component factory
     */
    NotificationService.prototype.showNotification = function (notificationObj, notificationComp) {
        var _this = this;
        if (notificationComp === void 0) { notificationComp = Notification; }
        var componentFactory = this.componentFactoryResolver.resolveComponentFactory(notificationComp);
        var notificationRef = componentFactory.create(this.injector);
        notificationRef.instance.notificationObj = notificationObj; // typescript isn't being very smart here, so we type to any
        this.notificationRefs.push(notificationRef);
        this.onClose = notificationRef.instance.close;
        this.applicationRef.attachView(notificationRef.hostView);
        if (notificationObj.target) {
            document.querySelector(notificationObj.target).appendChild(notificationRef.location.nativeElement);
        }
        else {
            var body = document.querySelector("body");
            // get or create a container for alert list
            var notificationClassName = "notification-overlay";
            var notificationList = body.querySelector("." + notificationClassName);
            if (!notificationList) {
                notificationList = document.createElement("div");
                notificationList.className = notificationClassName;
                body.appendChild(notificationList);
            }
            // add the notification to the top of the list
            if (notificationList.firstChild) {
                notificationList.insertBefore(notificationRef.location.nativeElement, notificationList.firstChild);
            }
            else {
                notificationList.appendChild(notificationRef.location.nativeElement);
            }
        }
        if (notificationObj.duration && notificationObj.duration > 0) {
            this.ngZone.runOutsideAngular(function () {
                setTimeout(function () {
                    _this.ngZone.run(function () {
                        _this.close(notificationRef);
                    });
                }, notificationObj.duration);
            });
        }
        if (notificationObj.smart) {
            this.ngZone.runOutsideAngular(function () {
                // let it disappear after calculated timeout
                setTimeout(function () {
                    _this.ngZone.run(function () {
                        _this.close(notificationRef);
                    });
                }, _this.getSmartTimeout(notificationObj));
            });
        }
        this.onClose.subscribe(function () {
            _this.close(notificationRef);
        });
        notificationRef.instance.componentRef = notificationRef;
        return notificationRef.instance;
    };
    NotificationService.prototype.showToast = function (notificationObj, notificationComp) {
        if (notificationComp === void 0) { notificationComp = Toast; }
        return this.showNotification(notificationObj, notificationComp);
    };
    /**
     * Programatically closes notification based on `notificationRef`.
     *
     * @param notificationRef `ComponentRef` of a notification or `Notification` component you wish to close
     */
    NotificationService.prototype.close = function (notificationRef) {
        if (notificationRef) {
            if (notificationRef instanceof Notification) {
                this.close(notificationRef.componentRef);
            }
            else {
                this.applicationRef.detachView(notificationRef.hostView);
                notificationRef.destroy();
                var index = this.notificationRefs.indexOf(notificationRef);
                if (index !== -1) {
                    this.notificationRefs.splice(index, 1);
                }
            }
        }
    };
    /**
     * Calculates the amount of time user needs to read the message in the notification.
     *
     * @param notificationObj Same object used to instantiate notification.
     *
     * In addition to `type` and `message` members, use `duration` member to add
     * some extra time (in ms) to timeout if you need to.
     * @returns calculated timeout (in ms) for smart notification
     */
    NotificationService.prototype.getSmartTimeout = function (notificationObj) {
        // calculate timeout
        var timeout = 600; // start with reaction time
        // custom duration
        timeout += notificationObj.duration || 0;
        // message type
        switch (notificationObj.type) {
            case "info":
            case "success":
            default: {
                break;
            }
            case "danger": {
                timeout += 3000;
                break;
            }
            case "warning": {
                timeout += 1500;
                break;
            }
        }
        // message length
        // average reader reads around 200 words per minute, or it takes them ~0.3s per word
        // let's use 1.5 factor for below average speed readers and have 0.45s per word
        var wordCount = notificationObj.message.trim().split(/\s+/).length;
        timeout += wordCount * 450;
        return timeout;
    };
    /**
     * OnDestroy hook.
     *
     * Destroys all living notifications it is responsible for.
     *
     */
    NotificationService.prototype.ngOnDestroy = function () {
        if (this.notificationRefs.length > 0) {
            for (var i = 0; i < this.notificationRefs.length; i++) {
                var notificationRef = this.notificationRefs[i];
                this.applicationRef.detachView(notificationRef.hostView);
                notificationRef.destroy();
            }
            this.notificationRefs.length = 0;
        }
    };
    NotificationService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    NotificationService.ctorParameters = function () { return [
        { type: Injector },
        { type: ComponentFactoryResolver },
        { type: ApplicationRef },
        { type: NgZone }
    ]; };
    return NotificationService;
}());
export { NotificationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9jYXJib24tY29tcG9uZW50cy1hbmd1bGFyL25vdGlmaWNhdGlvbi8iLCJzb3VyY2VzIjpbIm5vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTixjQUFjLEVBRWQsd0JBQXdCLEVBRXhCLFlBQVksRUFDWixVQUFVLEVBQ1YsUUFBUSxFQUVSLE1BQU0sRUFDTixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDeEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRTFDOzs7O0dBSUc7QUFDSDtJQVVDOzs7Ozs7T0FNRztJQUNILDZCQUNXLFFBQWtCLEVBQ2xCLHdCQUFrRCxFQUNsRCxjQUE4QixFQUM5QixNQUFjO1FBSGQsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO1FBQ2xELG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBbkJ6Qjs7OztXQUlHO1FBQ0kscUJBQWdCLEdBQUcsSUFBSSxLQUFLLEVBQXFCLENBQUM7UUFDbEQsWUFBTyxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO0lBY3ZELENBQUM7SUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7T0E2Qkc7SUFDSCw4Q0FBZ0IsR0FBaEIsVUFBaUIsZUFBbUQsRUFBRSxnQkFBK0I7UUFBckcsaUJBMkRDO1FBM0RxRSxpQ0FBQSxFQUFBLCtCQUErQjtRQUNwRyxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyx1QkFBdUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRWpHLElBQUksZUFBZSxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFD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QUNwRiwrRUFBK0U7UUFDL0UsSUFBSSxTQUFTLEdBQUcsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ25FLE9BQU8sSUFBSSxTQUFTLEdBQUcsR0FBRyxDQUFDO1FBRTNCLE9BQU8sT0FBTyxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILHlDQUFXLEdBQVg7UUFDQyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3JDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUN0RCxJQUFJLGVBQWUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQy9DLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDekQsZUFBZSxDQUFDLE9BQU8sRUFBRSxDQUFDO2FBQzFCO1lBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7U0FDakM7SUFDRixDQUFDOztnQkFwTUQsVUFBVTs7OztnQkFkVixRQUFRO2dCQUpSLHdCQUF3QjtnQkFGeEIsY0FBYztnQkFRZCxNQUFNOztJQWlOUCwwQkFBQztDQUFBLEFBck1ELElBcU1DO1NBcE1ZLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdEFwcGxpY2F0aW9uUmVmLFxuXHRDb21wb25lbnRGYWN0b3J5LFxuXHRDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG5cdENvbXBvbmVudFJlZixcblx0RXZlbnRFbWl0dGVyLFxuXHRJbmplY3RhYmxlLFxuXHRJbmplY3Rvcixcblx0T25EZXN0cm95LFxuXHROZ1pvbmVcbn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcblxuaW1wb3J0IHsgTm90aWZpY2F0aW9uQ29udGVudCwgVG9hc3RDb250ZW50IH0gZnJvbSBcIi4vbm90aWZpY2F0aW9uLWNvbnRlbnQuaW50ZXJmYWNlXCI7XG5pbXBvcnQgeyBOb3RpZmljYXRpb24gfSBmcm9tIFwiLi9ub3RpZmljYXRpb24uY29tcG9uZW50XCI7XG5pbXBvcnQgeyBUb2FzdCB9IGZyb20gXCIuL3RvYXN0LmNvbXBvbmVudFwiO1xuXG4vKipcbiAqIFByb3ZpZGVzIGEgd2F5IHRvIHVzZSB0aGUgbm90aWZpY2F0aW9uIGNvbXBvbmVudC5cbiAqXG4gKiBOb3RpZmljYXRpb25zIGFyZSBkaXNwbGF5ZWQgdG93YXJkIHRoZSB0b3Agb2YgdGhlIFVJIGFuZCBkbyBub3QgaW50ZXJydXB0IHRoZSB1c2Vy4oCZcyB3b3JrLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTm90aWZpY2F0aW9uU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG5cdC8qKlxuXHQgKiBBbiBhcnJheSBjb250YWluaW5nIGBDb21wb25lbnRSZWZgcyB0byBhbGwgdGhlIG5vdGlmaWNhdGlvbnMgdGhpcyBzZXJ2aWNlIGluc3RhbmNlXG5cdCAqIGlzIHJlc3BvbnNpYmxlIGZvci5cblx0ICpcblx0ICovXG5cdHB1YmxpYyBub3RpZmljYXRpb25SZWZzID0gbmV3IEFycmF5PENvbXBvbmVudFJlZjxhbnk+PigpO1xuXHRwdWJsaWMgb25DbG9zZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cblx0LyoqXG5cdCAqIENvbnN0cnVjdHMgTm90aWZpY2F0aW9uU2VydmljZS5cblx0ICpcblx0ICogQHBhcmFtIGluamVjdG9yXG5cdCAqIEBwYXJhbSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXJcblx0ICogQHBhcmFtIGFwcGxpY2F0aW9uUmVmXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yLFxuXHRcdHByb3RlY3RlZCBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcblx0XHRwcm90ZWN0ZWQgYXBwbGljYXRpb25SZWY6IEFwcGxpY2F0aW9uUmVmLFxuXHRcdHByb3RlY3RlZCBuZ1pvbmU6IE5nWm9uZSkge1xuXHR9XG5cblx0LyoqXG5cdCAqIFNob3dzIHRoZSBub3RpZmljYXRpb24gYmFzZWQgb24gdGhlIGBub3RpZmljYXRpb25PYmpgLlxuXHQgKlxuXHQgKiBAcGFyYW0gbm90aWZpY2F0aW9uT2JqIENhbiBoYXZlIGB0eXBlYCwgYG1lc3NhZ2VgLCBgdGFyZ2V0YCwgYGR1cmF0aW9uYCBhbmQgYHNtYXJ0YCBtZW1iZXJzLlxuXHQgKlxuXHQgKiAqKk1lbWJlcnM6Kipcblx0ICpcblx0ICogKiBgdHlwZWAgY2FuIGJlIG9uZSBvZiBgXCJpbmZvXCJgLCBgXCJ3YXJuaW5nXCJgLCBgXCJkYW5nZXJcImAsIGBcInN1Y2Nlc3NcImBcblx0ICogKiBgbWVzc2FnZWAgaXMgbWVzc2FnZSBmb3Igbm90aWZpY2F0aW9uIHRvIGRpc3BsYXlcblx0ICogKiBgdGFyZ2V0YCBpcyBjc3Mgc2VsZWN0b3IgZGVmaW5pbmcgYW4gZWxlbWVudCB0byBhcHBlbmQgbm90aWZpY2F0aW9uIHRvLiBJZiBub3QgcHJvdmlkZWQsXG5cdCAqIGBzaG93Tm90aWZpY2F0aW9uKClgIGNyZWF0ZXMgYSBwbGFjZSBmb3IgdGhlIG5vdGlmaWNhdGlvbiBpbiBgYm9keWBcblx0ICogKiBgZHVyYXRpb25gIGlzIG51bWJlciBvZiBtcyB0byBjbG9zZSB0aGUgbm90aWZpY2F0aW9uIGFmdGVyLiBJZiB1c2VkIGluIGNvbWJpbmF0aW9uIHdpdGggYHNtYXJ0YCxcblx0ICogaXQncyBhZGRlZCB0byB0aGUgY2FsY3VsYXRlZCB0aW1lb3V0XG5cdCAqICogYHNtYXJ0YCwgc2V0IHRvIGB0cnVlYCBpZiB5b3Ugd2FudCB0byB1c2Ugc21hcnQgbm90aWZpY2F0aW9uLlxuXHQgKlxuXHQgKiAqKkV4YW1wbGU6Kipcblx0ICogYGBgdHlwZXNjcmlwdFxuXHQgKiAvLyBJbmZvIG5vdGlmaWNhdGlvbiwgc2F5aW5nIFwiU2FtcGxlIG1lc3NhZ2UuXCIgYWRkZWQgdG8gdGhlIGVsZW1lbnQgd2l0aCBpZCBub3RpZmljYXRpb24tY29udGFpbmVyXG5cdCAqIC8vIHVzZXMgc21hcnQgdGltZW91dCB3aXRoIGFkZGVkIGR1cmF0aW9uIG9mIDEgc2Vjb25kLlxuXHQgKiB7XG5cdCAqXHR0eXBlOiBcImluZm9cIixcblx0ICpcdG1lc3NhZ2U6IFwiU2FtcGxlIG1lc3NhZ2UuXCIsXG5cdCAqXHR0YXJnZXQ6IFwiI25vdGlmaWNhdGlvbi1jb250YWluZXJcIixcblx0ICpcdGR1cmF0aW9uOiAxMDAwLFxuXHQgKlx0c21hcnQ6IHRydWVcblx0ICogfVxuXHQgKiBgYGBcblx0ICpcblx0ICogQHBhcmFtIFtub3RpZmljYXRpb25Db21wPU5vdGlmaWNhdGlvbl0gSWYgcHJvdmlkZWQsIHVzZWQgdG8gcmVzb2x2ZSBjb21wb25lbnQgZmFjdG9yeVxuXHQgKi9cblx0c2hvd05vdGlmaWNhdGlvbihub3RpZmljYXRpb25PYmo6IE5vdGlmaWNhdGlvbkNvbnRlbnQgfCBUb2FzdENvbnRlbnQsIG5vdGlmaWNhdGlvbkNvbXAgPSBOb3RpZmljYXRpb24pIHtcblx0XHRjb25zdCBjb21wb25lbnRGYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3Rvcnkobm90aWZpY2F0aW9uQ29tcCk7XG5cblx0XHRsZXQgbm90aWZpY2F0aW9uUmVmID0gY29tcG9uZW50RmFjdG9yeS5jcmVhdGUodGhpcy5pbmplY3Rvcik7XG5cdFx0bm90aWZpY2F0aW9uUmVmLmluc3RhbmNlLm5vdGlmaWNhdGlvbk9iaiA9IG5vdGlmaWNhdGlvbk9iaiBhcyBhbnk7IC8vIHR5cGVzY3JpcHQgaXNuJ3QgYmVpbmcgdmVyeSBzbWFydCBoZXJlLCBzbyB3ZSB0eXBlIHRvIGFueVxuXHRcdHRoaXMubm90aWZpY2F0aW9uUmVmcy5wdXNoKG5vdGlmaWNhdGlvblJlZik7XG5cblx0XHR0aGlzLm9uQ2xvc2UgPSBub3RpZmljYXRpb25SZWYuaW5zdGFuY2UuY2xvc2U7XG5cdFx0dGhpcy5hcHBsaWNhdGlvblJlZi5hdHRhY2hWaWV3KG5vdGlmaWNhdGlvblJlZi5ob3N0Vmlldyk7XG5cblx0XHRpZiAobm90aWZpY2F0aW9uT2JqLnRhcmdldCkge1xuXHRcdFx0ZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihub3RpZmljYXRpb25PYmoudGFyZ2V0KS5hcHBlbmRDaGlsZChub3RpZmljYXRpb25SZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxldCBib2R5ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcImJvZHlcIik7XG5cblx0XHRcdC8vIGdldCBvciBjcmVhdGUgYSBjb250YWluZXIgZm9yIGFsZXJ0IGxpc3Rcblx0XHRcdGxldCBub3RpZmljYXRpb25DbGFzc05hbWUgPSBcIm5vdGlmaWNhdGlvbi1vdmVybGF5XCI7XG5cdFx0XHRsZXQgbm90aWZpY2F0aW9uTGlzdCA9IGJvZHkucXVlcnlTZWxlY3RvcihgLiR7bm90aWZpY2F0aW9uQ2xhc3NOYW1lfWApO1xuXHRcdFx0aWYgKCFub3RpZmljYXRpb25MaXN0KSB7XG5cdFx0XHRcdG5vdGlmaWNhdGlvbkxpc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuXHRcdFx0XHRub3RpZmljYXRpb25MaXN0LmNsYXNzTmFtZSA9IG5vdGlmaWNhdGlvbkNsYXNzTmFtZTtcblx0XHRcdFx0Ym9keS5hcHBlbmRDaGlsZChub3RpZmljYXRpb25MaXN0KTtcblx0XHRcdH1cblxuXHRcdFx0Ly8gYWRkIHRoZSBub3RpZmljYXRpb24gdG8gdGhlIHRvcCBvZiB0aGUgbGlzdFxuXHRcdFx0aWYgKG5vdGlmaWNhdGlvbkxpc3QuZmlyc3RDaGlsZCkge1xuXHRcdFx0XHRub3RpZmljYXRpb25MaXN0Lmluc2VydEJlZm9yZShub3RpZmljYXRpb25SZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudCwgbm90aWZpY2F0aW9uTGlzdC5maXJzdENoaWxkKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdG5vdGlmaWNhdGlvbkxpc3QuYXBwZW5kQ2hpbGQobm90aWZpY2F0aW9uUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmIChub3RpZmljYXRpb25PYmouZHVyYXRpb24gJiYgbm90aWZpY2F0aW9uT2JqLmR1cmF0aW9uID4gMCkge1xuXHRcdFx0dGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuXHRcdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0XHR0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuXHRcdFx0XHRcdFx0dGhpcy5jbG9zZShub3RpZmljYXRpb25SZWYpO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9LCBub3RpZmljYXRpb25PYmouZHVyYXRpb24pO1xuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0aWYgKG5vdGlmaWNhdGlvbk9iai5zbWFydCkge1xuXHRcdFx0dGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuXHRcdFx0XHQvLyBsZXQgaXQgZGlzYXBwZWFyIGFmdGVyIGNhbGN1bGF0ZWQgdGltZW91dFxuXHRcdFx0XHRzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0XHR0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuXHRcdFx0XHRcdFx0dGhpcy5jbG9zZShub3RpZmljYXRpb25SZWYpO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9LCB0aGlzLmdldFNtYXJ0VGltZW91dChub3RpZmljYXRpb25PYmopKTtcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHRoaXMub25DbG9zZS5zdWJzY3JpYmUoKCkgPT4ge1xuXHRcdFx0dGhpcy5jbG9zZShub3RpZmljYXRpb25SZWYpO1xuXHRcdH0pO1xuXG5cdFx0bm90aWZpY2F0aW9uUmVmLmluc3RhbmNlLmNvbXBvbmVudFJlZiA9IG5vdGlmaWNhdGlvblJlZjtcblx0XHRyZXR1cm4gbm90aWZpY2F0aW9uUmVmLmluc3RhbmNlO1xuXHR9XG5cblx0c2hvd1RvYXN0KG5vdGlmaWNhdGlvbk9iajogTm90aWZpY2F0aW9uQ29udGVudCB8IFRvYXN0Q29udGVudCwgbm90aWZpY2F0aW9uQ29tcCA9IFRvYXN0KSB7XG5cdFx0cmV0dXJuIHRoaXMuc2hvd05vdGlmaWNhdGlvbihub3RpZmljYXRpb25PYmosIG5vdGlmaWNhdGlvbkNvbXAgYXMgYW55KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBQcm9ncmFtYXRpY2FsbHkgY2xvc2VzIG5vdGlmaWNhdGlvbiBiYXNlZCBvbiBgbm90aWZpY2F0aW9uUmVmYC5cblx0ICpcblx0ICogQHBhcmFtIG5vdGlmaWNhdGlvblJlZiBgQ29tcG9uZW50UmVmYCBvZiBhIG5vdGlmaWNhdGlvbiBvciBgTm90aWZpY2F0aW9uYCBjb21wb25lbnQgeW91IHdpc2ggdG8gY2xvc2Vcblx0ICovXG5cdGNsb3NlKG5vdGlmaWNhdGlvblJlZjogYW55KSB7XG5cdFx0aWYgKG5vdGlmaWNhdGlvblJlZikge1xuXHRcdFx0aWYgKG5vdGlmaWNhdGlvblJlZiBpbnN0YW5jZW9mIE5vdGlmaWNhdGlvbikge1xuXHRcdFx0XHR0aGlzLmNsb3NlKG5vdGlmaWNhdGlvblJlZi5jb21wb25lbnRSZWYpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5hcHBsaWNhdGlvblJlZi5kZXRhY2hWaWV3KG5vdGlmaWNhdGlvblJlZi5ob3N0Vmlldyk7XG5cdFx0XHRcdG5vdGlmaWNhdGlvblJlZi5kZXN0cm95KCk7XG5cdFx0XHRcdGNvbnN0IGluZGV4ID0gdGhpcy5ub3RpZmljYXRpb25SZWZzLmluZGV4T2Yobm90aWZpY2F0aW9uUmVmKTtcblx0XHRcdFx0aWYgKGluZGV4ICE9PSAtMSkge1xuXHRcdFx0XHRcdHRoaXMubm90aWZpY2F0aW9uUmVmcy5zcGxpY2UoaW5kZXgsIDEpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIENhbGN1bGF0ZXMgdGhlIGFtb3VudCBvZiB0aW1lIHVzZXIgbmVlZHMgdG8gcmVhZCB0aGUgbWVzc2FnZSBpbiB0aGUgbm90aWZpY2F0aW9uLlxuXHQgKlxuXHQgKiBAcGFyYW0gbm90aWZpY2F0aW9uT2JqIFNhbWUgb2JqZWN0IHVzZWQgdG8gaW5zdGFudGlhdGUgbm90aWZpY2F0aW9uLlxuXHQgKlxuXHQgKiBJbiBhZGRpdGlvbiB0byBgdHlwZWAgYW5kIGBtZXNzYWdlYCBtZW1iZXJzLCB1c2UgYGR1cmF0aW9uYCBtZW1iZXIgdG8gYWRkXG5cdCAqIHNvbWUgZXh0cmEgdGltZSAoaW4gbXMpIHRvIHRpbWVvdXQgaWYgeW91IG5lZWQgdG8uXG5cdCAqIEByZXR1cm5zIGNhbGN1bGF0ZWQgdGltZW91dCAoaW4gbXMpIGZvciBzbWFydCBub3RpZmljYXRpb25cblx0ICovXG5cdGdldFNtYXJ0VGltZW91dChub3RpZmljYXRpb25PYmopOiBudW1iZXIge1xuXHRcdC8vIGNhbGN1bGF0ZSB0aW1lb3V0XG5cdFx0bGV0IHRpbWVvdXQgPSA2MDA7IC8vIHN0YXJ0IHdpdGggcmVhY3Rpb24gdGltZVxuXG5cdFx0Ly8gY3VzdG9tIGR1cmF0aW9uXG5cdFx0dGltZW91dCArPSBub3RpZmljYXRpb25PYmouZHVyYXRpb24gfHwgMDtcblxuXHRcdC8vIG1lc3NhZ2UgdHlwZVxuXHRcdHN3aXRjaCAobm90aWZpY2F0aW9uT2JqLnR5cGUpIHtcblx0XHRcdGNhc2UgXCJpbmZvXCI6XG5cdFx0XHRjYXNlIFwic3VjY2Vzc1wiOlxuXHRcdFx0ZGVmYXVsdDoge1xuXHRcdFx0XHRicmVhaztcblx0XHRcdH1cblx0XHRcdGNhc2UgXCJkYW5nZXJcIjoge1xuXHRcdFx0XHR0aW1lb3V0ICs9IDMwMDA7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0fVxuXHRcdFx0Y2FzZSBcIndhcm5pbmdcIjoge1xuXHRcdFx0XHR0aW1lb3V0ICs9IDE1MDA7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdC8vIG1lc3NhZ2UgbGVuZ3RoXG5cdFx0Ly8gYXZlcmFnZSByZWFkZXIgcmVhZHMgYXJvdW5kIDIwMCB3b3JkcyBwZXIgbWludXRlLCBvciBpdCB0YWtlcyB0aGVtIH4wLjNzIHBlciB3b3JkXG5cdFx0Ly8gbGV0J3MgdXNlIDEuNSBmYWN0b3IgZm9yIGJlbG93IGF2ZXJhZ2Ugc3BlZWQgcmVhZGVycyBhbmQgaGF2ZSAwLjQ1cyBwZXIgd29yZFxuXHRcdGxldCB3b3JkQ291bnQgPSBub3RpZmljYXRpb25PYmoubWVzc2FnZS50cmltKCkuc3BsaXQoL1xccysvKS5sZW5ndGg7XG5cdFx0dGltZW91dCArPSB3b3JkQ291bnQgKiA0NTA7XG5cblx0XHRyZXR1cm4gdGltZW91dDtcblx0fVxuXG5cdC8qKlxuXHQgKiBPbkRlc3Ryb3kgaG9vay5cblx0ICpcblx0ICogRGVzdHJveXMgYWxsIGxpdmluZyBub3RpZmljYXRpb25zIGl0IGlzIHJlc3BvbnNpYmxlIGZvci5cblx0ICpcblx0ICovXG5cdG5nT25EZXN0cm95KCkge1xuXHRcdGlmICh0aGlzLm5vdGlmaWNhdGlvblJlZnMubGVuZ3RoID4gMCkge1xuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm5vdGlmaWNhdGlvblJlZnMubGVuZ3RoOyBpKyspIHtcblx0XHRcdFx0bGV0IG5vdGlmaWNhdGlvblJlZiA9IHRoaXMubm90aWZpY2F0aW9uUmVmc1tpXTtcblx0XHRcdFx0dGhpcy5hcHBsaWNhdGlvblJlZi5kZXRhY2hWaWV3KG5vdGlmaWNhdGlvblJlZi5ob3N0Vmlldyk7XG5cdFx0XHRcdG5vdGlmaWNhdGlvblJlZi5kZXN0cm95KCk7XG5cdFx0XHR9XG5cdFx0XHR0aGlzLm5vdGlmaWNhdGlvblJlZnMubGVuZ3RoID0gMDtcblx0XHR9XG5cdH1cbn1cbiJdfQ==